<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .main-shop {
            display: none;
            /* ‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
        }
    </style>
</head>

<body class="bg-white min-h-screen p-6">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-[#F5F8FD] z-50">
        <div class="text-center">
            <div class="relative flex w-64 animate-pulse gap-2 p-4">
                <div class="h-12 w-12 rounded-full bg-slate-400"></div>
                <div class="flex-1">
                    <div class="mb-1 h-5 w-3/5 rounded-lg bg-slate-400"></div>
                    <div class="h-5 w-[90%] rounded-lg bg-slate-400"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-shop">
        <div class="max-w-md m-auto">
            <div class="mb-4">
                <!-- Sort Field -->
                <div class="flex justify-between">
                    <h1 class="text-md font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
                    <select id="filter-sort" class="border px-2 py-1 rounded-xl">
                        <option value="desc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                        <option value="asc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                    </select>
                </div>
            </div>

            <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <div id="data-table-container" class="overflow-x-auto">
                <table id="data-table" class="min-w-full border-collapse text-sm">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium border-b uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="px-4 py-3 text-left text-sm font-medium border-b uppercase">‡∏ä‡∏∑‡πà‡∏≠</th>
                            <th class="px-4 py-3 text-left text-sm font-medium border-b uppercase">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                            <th class="px-4 py-3 text-left text-sm font-medium border-b uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="px-4 py-3 text-left text-sm font-medium border-b uppercase">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</th>
                        </tr>
                    </thead>
                    <tbody id="data-tbody" class="bg-white">
                        <!-- ‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÇ‡∏î‡∏¢ JS -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="flex justify-center mt-4">
                <!-- Pagination buttons will be generated here -->
            </div>

            <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." -->
            <div id="loading-message" class="text-center text-gray-100 mb-4" style="display: none;">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxdUHOPhzdZLf-G0qz4WUjyV57RKFyFe7kRem4ieu3cRAO95wJ-ltpE15o2SSJvU3_H/exec';
        const ROWS_PER_PAGE = 10;
        let currentPage = 1;
        let tableData = [];
        let filteredData = [];

        window.onload = fetchData;

        async function fetchData() {
            showLoading(true);
            try {
                const response = await fetch(WEB_APP_URL);
                const data = await response.json();
                tableData = processOrders(data.slice(1));
                filteredData = tableData;
                applyFilters();
            } catch (error) {
                console.error('Error fetching data:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'
                });
            } finally {
                showLoading(false);
            }
        }

        function showLoading(isLoading) {
            const loadingScreen = document.getElementById('loading-screen');
            const mainShop = document.querySelector('.main-shop');
            if (isLoading) {
                loadingScreen.style.display = 'flex';
                mainShop.style.display = 'none';
            } else {
                loadingScreen.style.display = 'none';
                mainShop.style.display = 'block';
            }
        }

        function processOrders(data) {
            const processedData = [];
            const orderMap = {};

            data.forEach(row => {
                const orderId = row[0];
                const totalOrder = parseFloat(row[10]);
                const totalPrice = parseFloat(row[11]);
                const rawTimestamp = row[12];
                const timestamp = new Date(rawTimestamp);
                const paymentStatus = row[13];

                if (!orderMap[orderId]) {
                    orderMap[orderId] = {
                        orderId: orderId,
                        name: row[1],
                        address: row[2],
                        contact: row[3],
                        note: row[4],
                        totalOrder: totalOrder,
                        totalPrice: totalPrice,
                        timestamp: timestamp,
                        paymentStatus: paymentStatus,
                        products: []
                    };
                } else {
                    orderMap[orderId].totalOrder += totalOrder;
                    orderMap[orderId].totalPrice += totalPrice;
                }

                orderMap[orderId].products.push({
                    idProduct: row[6],
                    product: row[7],
                    price: row[8],
                    size: row[9],
                    value: row[10],
                    totalOrder: totalOrder
                });
            });

            for (let orderId in orderMap) {
                processedData.push(orderMap[orderId]);
            }
            return processedData;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏ñ‡πâ‡∏≤ .00 ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å
        function formatPrice(price) {
            if (Number.isInteger(price)) {
                return price.toString();
            } else {
                return String(price);
            }
        }

        // ‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥
        function getStatusEmoji(status) {
            if (status === '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') {
                return '‚úÖ';  // ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
            } else if (status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô') {
                return '‚ö†Ô∏è'; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞
            } else if (status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤') {
                return '‚ùå'; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            } else {
                return status; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            }
        }

        function applyFilters() {
            const filterSort = document.getElementById('filter-sort').value;
            filteredData.sort((a, b) => {
                return filterSort === 'asc'
                    ? a.timestamp - b.timestamp
                    : b.timestamp - a.timestamp;
            });
            currentPage = 1;
            displayCards(filteredData);
            renderPagination(filteredData.length);
        }

        function displayCards(data) {
            const tbody = document.getElementById('data-tbody');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * ROWS_PER_PAGE;
            const end = start + ROWS_PER_PAGE;
            const paginatedData = data.slice(start, end);

            paginatedData.forEach(order => {
                // (1) ‡πÅ‡∏ñ‡∏ß‡∏´‡∏•‡∏±‡∏Å
                const mainRow = document.createElement('tr');

                const dateCell = document.createElement('td');
                dateCell.className = 'px-4 py-2';
                dateCell.textContent = formatDate(order.timestamp);

                const nameCell = document.createElement('td');
                nameCell.className = 'px-4 py-2';
                nameCell.textContent = order.name;

                const priceCell = document.createElement('td');
                priceCell.className = 'px-4 py-2';
                priceCell.textContent = `${formatPrice(order.totalPrice)} ‡∏ö‡∏≤‡∏ó`;

                const statusCell = document.createElement('td');
                statusCell.className = 'px-4 py-2';
                statusCell.textContent = getStatusEmoji(order.paymentStatus);

                // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á"
                const commandCell = document.createElement('td');
                commandCell.className = 'px-4 py-2 text-center';

                const commandButton = document.createElement('button');
                commandButton.textContent = 'üìã';
                commandButton.className = 'bg-indigo-600 text-white py-1 px-3 rounded hover:bg-indigo-700';
                commandButton.onclick = () => toggleDetails(`detail-${order.orderId}`);
                commandCell.appendChild(commandButton);

                mainRow.appendChild(dateCell);
                mainRow.appendChild(nameCell);
                mainRow.appendChild(priceCell);
                mainRow.appendChild(statusCell);
                mainRow.appendChild(commandCell);

                tbody.appendChild(mainRow);

                // (2) ‡πÅ‡∏ñ‡∏ß‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å
                const detailRow = document.createElement('tr');
                detailRow.id = `detail-${order.orderId}`;
                detailRow.className = 'border-b hidden';

                const detailCell = document.createElement('td');
                detailCell.colSpan = 5; // ‡πÄ‡∏£‡∏≤‡∏°‡∏µ 5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                detailCell.className = 'px-4 py-2 bg-gray-50';

                let detailHtml = `
          <div class="mb-2">
            <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${order.name}</p>
            <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> ${order.contact}</p>
            <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${order.address}</p>

            <p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${order.note || '-'}</p>
          </div>
          <div class="mb-2">
            <p><strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</strong></p>
        `;

                order.products.forEach(prod => {
                    detailHtml += `
            <div class="ml-4 mb-1">
              <p><strong>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ${prod.product} (${prod.price} ‡∏ö‡∏≤‡∏ó) x ${prod.totalOrder}</p>
            </div>
          `;
                });

                detailHtml += `
          <p class="mt-2"><strong>‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</strong> ${formatPrice(order.totalPrice)} ‡∏ö‡∏≤‡∏ó</p>
          <p><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${formatDate(order.timestamp)}</p>
          </div>
        `;

                // ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
                const isPaid = (order.paymentStatus === '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                detailHtml += `
          <div class="flex flex-wrap gap-2 mt-3">
            <button 
              class="bg-gray-800 text-white px-4 py-1 rounded hover:bg-gray-600 ${isPaid ? 'opacity-50 cursor-not-allowed' : ''}"
              ${isPaid ? 'disabled' : ''}
              onclick="if(!${isPaid}) { openPaymentOptions('${order.orderId}'); }"
            >
              ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            </button>
          </div>
        `;

                detailCell.innerHTML = detailHtml;
                detailRow.appendChild(detailCell);
                tbody.appendChild(detailRow);
            });
        }

        function renderPagination(totalRows) {
            const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const maxPages = 3;
            let startPage = Math.max(1, currentPage - 1);
            let endPage = Math.min(totalPages, startPage + maxPages - 1);

            if (endPage - startPage < maxPages - 1) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }

            if (startPage > 1) {
                const prevButton = document.createElement('button');
                prevButton.className = 'mx-1 px-3 py-1 bg-gray-300 rounded-xl';
                prevButton.innerText = 'Prev';
                prevButton.onclick = () => {
                    currentPage = startPage - 1;
                    displayCards(filteredData);
                    renderPagination(totalRows);
                };
                pagination.appendChild(prevButton);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = `mx-1 px-3 py-1 rounded-xl ${i === currentPage ? 'bg-blue-500 text-white' : 'bg-gray-300'}`;
                pageButton.innerText = i;
                pageButton.onclick = () => {
                    currentPage = i;
                    displayCards(filteredData);
                    renderPagination(totalRows);
                };
                pagination.appendChild(pageButton);
            }

            if (endPage < totalPages) {
                const nextButton = document.createElement('button');
                nextButton.className = 'mx-1 px-3 py-1 bg-gray-300 rounded-xl';
                nextButton.innerText = 'Next';
                nextButton.onclick = () => {
                    currentPage = endPage + 1;
                    displayCards(filteredData);
                    renderPagination(totalRows);
                };
                pagination.appendChild(nextButton);
            }
        }

        // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
        function formatDate(isoString) {
            const date = new Date(isoString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        // Toggle ‡πÅ‡∏ñ‡∏ß‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        function toggleDetails(id) {
            const detailRow = document.getElementById(id);
            if (detailRow.classList.contains('hidden')) {
                detailRow.classList.remove('hidden');
            } else {
                detailRow.classList.add('hidden');
            }
        }

        // SweetAlert ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
        function openPaymentOptions(orderId) {
            Swal.fire({
                title: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
                input: 'radio',
                inputOptions: {
                    '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à': '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'
                },
                inputValidator: (value) => {
                    if (!value) {
                        return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô!';
                    }
                },
                showCancelButton: true,
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...',
                        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    updatePaymentStatus(orderId, result.value);
                }
            });
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
        function updatePaymentStatus(orderId, paymentMethod) {
            $.post(WEB_APP_URL, {
                method: 'updateOrderData',
                orderId: orderId,
                payment: paymentMethod
            }, function (response) {
                Swal.fire({
                    icon: 'success',
                    title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Order ID: ${orderId} ‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô ${paymentMethod}`
                });
                fetchData();
            }).fail(function (error) {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'
                });
            });
        }

        document.getElementById('filter-sort').addEventListener('change', applyFilters);
    </script>
</body>

</html>
